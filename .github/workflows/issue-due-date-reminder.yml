name: Issue Due Date Reminder

on:
  schedule:
    # æ¯æ—¥ JST 09:00 (UTC 00:00) ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-due-dates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check issues with due dates
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // ãƒªãƒã‚¤ãƒ³ãƒ‰è¨­å®šï¼ˆä½•æ—¥å‰ã‹ã‚‰é€šçŸ¥ã™ã‚‹ã‹ï¼‰
            const remindDaysBefore = [7, 3, 1, 0]; // 7æ—¥å‰ã€3æ—¥å‰ã€1æ—¥å‰ã€å½“æ—¥
            
            // å…¨ã¦ã®ã‚ªãƒ¼ãƒ—ãƒ³Issueã‚’å–å¾—
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            console.log(`Found ${issues.data.length} open issues`);
            
            for (const issue of issues.data) {
              // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰æœŸé™ã‚’æŠ½å‡º
              // å¯¾å¿œãƒ‘ã‚¿ãƒ¼ãƒ³: ã€11/25ç· åˆ‡ã€‘ã€ã€2025/11/25ç· åˆ‡ã€‘ã€ã€11/25ã€‘ã€[11/25ç· åˆ‡]
              const patterns = [
                /ã€(\d{1,2})\/(\d{1,2})ç· åˆ‡?ã€‘/,
                /ã€(\d{4})\/(\d{1,2})\/(\d{1,2})ç· åˆ‡?ã€‘/,
                /ã€(\d{1,2})\/(\d{1,2})ã€‘/,
                /\[(\d{1,2})\/(\d{1,2})ç· åˆ‡?\]/,
                /\[(\d{4})\/(\d{1,2})\/(\d{1,2})ç· åˆ‡?\]/
              ];
              
              let dueDate = null;
              
              for (const pattern of patterns) {
                const match = issue.title.match(pattern);
                if (match) {
                  if (match.length === 3) {
                    // å¹´ãªã—ãƒ‘ã‚¿ãƒ¼ãƒ³ (11/25)
                    const month = parseInt(match[1]);
                    const day = parseInt(match[2]);
                    const year = today.getFullYear();
                    dueDate = new Date(year, month - 1, day);
                    
                    // éå»ã®æ—¥ä»˜ãªã‚‰æ¥å¹´ã¨ã¿ãªã™
                    if (dueDate < today) {
                      dueDate.setFullYear(year + 1);
                    }
                  } else if (match.length === 4) {
                    // å¹´ã‚ã‚Šãƒ‘ã‚¿ãƒ¼ãƒ³ (2025/11/25)
                    const year = parseInt(match[1]);
                    const month = parseInt(match[2]);
                    const day = parseInt(match[3]);
                    dueDate = new Date(year, month - 1, day);
                  }
                  break;
                }
              }
              
              if (!dueDate) {
                continue; // æœŸé™ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
              }
              
              // æœŸé™ã¾ã§ã®æ—¥æ•°ã‚’è¨ˆç®—
              const diffTime = dueDate - today;
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
              
              console.log(`Issue #${issue.number}: "${issue.title}" - Due in ${diffDays} days`);
              
              // ãƒªãƒã‚¤ãƒ³ãƒ‰ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
              if (remindDaysBefore.includes(diffDays)) {
                let emoji = 'â°';
                let urgency = '';
                
                if (diffDays === 0) {
                  emoji = 'ğŸš¨';
                  urgency = '**ä»Šæ—¥ãŒç· åˆ‡ã§ã™ï¼**';
                } else if (diffDays === 1) {
                  emoji = 'âš ï¸';
                  urgency = '**æ˜æ—¥ãŒç· åˆ‡ã§ã™ï¼**';
                } else if (diffDays === 3) {
                  emoji = 'ğŸ“¢';
                  urgency = 'ç· åˆ‡ã¾ã§ã‚ã¨3æ—¥ã§ã™ã€‚';
                } else if (diffDays === 7) {
                  emoji = 'ğŸ“…';
                  urgency = 'ç· åˆ‡ã¾ã§1é€±é–“ã§ã™ã€‚';
                }
                
                // éå»ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number
                });
                
                const todayStr = today.toISOString().split('T')[0];
                const alreadyReminded = comments.data.some(comment => 
                  comment.user.login === 'github-actions[bot]' &&
                  comment.body.includes('Due Date Reminder') &&
                  comment.body.includes(todayStr)
                );
                
                if (!alreadyReminded) {
                  // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
                  const dueDateStr = dueDate.toLocaleDateString('ja-JP');
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `${emoji} **Due Date Reminder** ${emoji}

${urgency}

**æœŸé™**: ${dueDateStr} (ã‚ã¨${diffDays}æ—¥)

<!-- Due Date Reminder: ${todayStr} -->`
                  });
                  
                  console.log(`âœ“ Reminded for Issue #${issue.number}`);
                  
                  // ã‚¢ã‚µã‚¤ãƒ³ã•ã‚Œã¦ã„ã‚‹äººã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹å ´åˆ
                  if (issue.assignees && issue.assignees.length > 0) {
                    const mentions = issue.assignees.map(a => `@${a.login}`).join(' ');
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      body: `${mentions} ğŸ‘† æœŸé™ãŒè¿‘ã¥ã„ã¦ã„ã¾ã™`
                    });
                  }
                } else {
                  console.log(`- Already reminded for Issue #${issue.number} today`);
                }
              }
              
              // æœŸé™åˆ‡ã‚Œã®ãƒã‚§ãƒƒã‚¯
              if (diffDays < 0) {
                // æœŸé™åˆ‡ã‚Œãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                try {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: ['â° æœŸé™åˆ‡ã‚Œ']
                  });
                  console.log(`Added "æœŸé™åˆ‡ã‚Œ" label to Issue #${issue.number}`);
                } catch (error) {
                  console.log(`Label "â° æœŸé™åˆ‡ã‚Œ" might not exist, skipping...`);
                }
              }
            }
